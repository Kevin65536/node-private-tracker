<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTç«™ç½‘ç»œè¿æ¥æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-item {
            margin: 15px 0;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            background: #fafafa;
        }
        .status {
            font-weight: bold;
            margin-left: 10px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .loading { color: #007bff; }
        .btn {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        #logs {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin-top: 20px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” PTç«™ç½‘ç»œè¿æ¥è¯Šæ–­å·¥å…·</h1>
        <p>è¿™ä¸ªå·¥å…·å°†å¸®åŠ©è¯Šæ–­ä¸ºä»€ä¹ˆæ— æ³•è®¿é—® PTç«™æœåŠ¡å™¨</p>
        
        <div class="test-item">
            <h3>ğŸŒ åŸºç¡€è¿æ¥æµ‹è¯•</h3>
            <div>ç›®æ ‡æœåŠ¡å™¨: <strong>172.21.134.69</strong></div>
            <button class="btn" onclick="testBasicConnection()">å¼€å§‹æµ‹è¯•</button>
            <div id="basic-status" class="status"></div>
        </div>

        <div class="test-item">
            <h3>ğŸ”Œ ç«¯å£è¿é€šæ€§æµ‹è¯•</h3>
            <button class="btn" onclick="testPorts()">æµ‹è¯•ç«¯å£</button>
            <div id="port-status" class="status"></div>
        </div>

        <div class="test-item">
            <h3>ğŸŒ HTTPæœåŠ¡æµ‹è¯•</h3>
            <button class="btn" onclick="testHttpServices()">æµ‹è¯•HTTP</button>
            <div id="http-status" class="status"></div>
        </div>

        <div class="test-item">
            <h3>ğŸ“Š æµè§ˆå™¨ä¿¡æ¯</h3>
            <div id="browser-info"></div>
        </div>

        <div class="test-item">
            <h3>ğŸ”§ å¿«é€Ÿä¿®å¤</h3>
            <button class="btn" onclick="showFixSuggestions()">æ˜¾ç¤ºä¿®å¤å»ºè®®</button>
            <div id="fix-suggestions"></div>
        </div>

        <h3>ğŸ“‹ è¯Šæ–­æ—¥å¿—</h3>
        <div id="logs"></div>
        
        <button class="btn" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        <button class="btn" onclick="exportLogs()">å¯¼å‡ºæ—¥å¿—</button>
    </div>

    <script>
        const TARGET_IP = '172.21.134.69';
        const FRONTEND_PORT = 3000;
        const BACKEND_PORT = 3001;
        
        let logs = '';

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = {
                'info': '[INFO]',
                'success': '[SUCCESS]', 
                'error': '[ERROR]',
                'warning': '[WARNING]'
            }[type] || '[INFO]';
            
            const logMessage = `${timestamp} ${prefix} ${message}\n`;
            logs += logMessage;
            document.getElementById('logs').textContent = logs;
            document.getElementById('logs').scrollTop = document.getElementById('logs').scrollHeight;
        }

        function clearLogs() {
            logs = '';
            document.getElementById('logs').textContent = '';
        }

        function exportLogs() {
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pt-site-diagnosis-${new Date().toISOString().substr(0, 19).replace(/:/g, '-')}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        async function testBasicConnection() {
            log('å¼€å§‹åŸºç¡€è¿æ¥æµ‹è¯•...');
            updateStatus('basic-status', 'æµ‹è¯•ä¸­...', 'loading');

            try {
                // æµ‹è¯•æ˜¯å¦èƒ½åŠ è½½ä¸€ä¸ªç®€å•çš„å›¾ç‰‡æ¥éªŒè¯ç½‘ç»œ
                const img = new Image();
                img.onload = () => {
                    log('ç½‘ç»œè¿æ¥æ­£å¸¸', 'success');
                    updateStatus('basic-status', 'âœ… ç½‘ç»œè¿æ¥æ­£å¸¸', 'success');
                };
                img.onerror = () => {
                    log('ç½‘ç»œè¿æ¥å¼‚å¸¸', 'error');
                    updateStatus('basic-status', 'âŒ ç½‘ç»œè¿æ¥å¼‚å¸¸', 'error');
                };
                img.src = `http://${TARGET_IP}:${FRONTEND_PORT}/favicon.ico?t=${Date.now()}`;
                
                // è¶…æ—¶å¤„ç†
                setTimeout(() => {
                    if (document.getElementById('basic-status').textContent.includes('æµ‹è¯•ä¸­')) {
                        log('è¿æ¥æµ‹è¯•è¶…æ—¶', 'warning');
                        updateStatus('basic-status', 'âš ï¸ è¿æ¥è¶…æ—¶', 'warning');
                    }
                }, 5000);
                
            } catch (error) {
                log(`è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                updateStatus('basic-status', 'âŒ è¿æ¥å¤±è´¥', 'error');
            }
        }

        async function testPorts() {
            log('å¼€å§‹ç«¯å£è¿é€šæ€§æµ‹è¯•...');
            updateStatus('port-status', 'æµ‹è¯•ä¸­...', 'loading');

            const ports = [
                { port: FRONTEND_PORT, name: 'å‰ç«¯' },
                { port: BACKEND_PORT, name: 'åç«¯API' }
            ];

            let results = [];
            
            for (const portInfo of ports) {
                try {
                    log(`æµ‹è¯•ç«¯å£ ${portInfo.port} (${portInfo.name})...`);
                    
                    const response = await fetch(`http://${TARGET_IP}:${portInfo.port}/`, {
                        method: 'HEAD',
                        mode: 'no-cors',
                        cache: 'no-cache'
                    });
                    
                    results.push(`âœ… ${portInfo.name}ç«¯å£ ${portInfo.port} å¯è¾¾`);
                    log(`ç«¯å£ ${portInfo.port} æµ‹è¯•æˆåŠŸ`, 'success');
                    
                } catch (error) {
                    results.push(`âŒ ${portInfo.name}ç«¯å£ ${portInfo.port} ä¸å¯è¾¾`);
                    log(`ç«¯å£ ${portInfo.port} æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                }
            }

            updateStatus('port-status', results.join(' | '), results.some(r => r.includes('âŒ')) ? 'error' : 'success');
        }

        async function testHttpServices() {
            log('å¼€å§‹HTTPæœåŠ¡æµ‹è¯•...');
            updateStatus('http-status', 'æµ‹è¯•ä¸­...', 'loading');

            const services = [
                { url: `http://${TARGET_IP}:${FRONTEND_PORT}/`, name: 'å‰ç«¯é¡µé¢' },
                { url: `http://${TARGET_IP}:${BACKEND_PORT}/health`, name: 'åç«¯API' }
            ];

            let results = [];

            for (const service of services) {
                try {
                    log(`æµ‹è¯• ${service.name}: ${service.url}`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    
                    const response = await fetch(service.url, {
                        signal: controller.signal,
                        mode: 'cors'
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        results.push(`âœ… ${service.name} æ­£å¸¸ (${response.status})`);
                        log(`${service.name} å“åº”æ­£å¸¸: HTTP ${response.status}`, 'success');
                    } else {
                        results.push(`âš ï¸ ${service.name} å¼‚å¸¸ (${response.status})`);
                        log(`${service.name} å“åº”å¼‚å¸¸: HTTP ${response.status}`, 'warning');
                    }
                    
                } catch (error) {
                    results.push(`âŒ ${service.name} å¤±è´¥`);
                    log(`${service.name} è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                }
            }

            updateStatus('http-status', results.join(' | '), results.some(r => r.includes('âŒ')) ? 'error' : 'success');
        }

        function showBrowserInfo() {
            const info = {
                'User Agent': navigator.userAgent,
                'æµè§ˆå™¨': navigator.appName,
                'ç‰ˆæœ¬': navigator.appVersion,
                'å¹³å°': navigator.platform,
                'è¯­è¨€': navigator.language,
                'Cookieå¯ç”¨': navigator.cookieEnabled,
                'åœ¨çº¿çŠ¶æ€': navigator.onLine,
                'å½“å‰URL': window.location.href,
                'åè®®': window.location.protocol,
                'ä¸»æœº': window.location.host
            };

            let infoHtml = '<table style="width:100%; font-size:12px;">';
            for (const [key, value] of Object.entries(info)) {
                infoHtml += `<tr><td style="font-weight:bold; padding:2px;">${key}:</td><td style="padding:2px;">${value}</td></tr>`;
            }
            infoHtml += '</table>';

            document.getElementById('browser-info').innerHTML = infoHtml;
            log('æµè§ˆå™¨ä¿¡æ¯å·²æ˜¾ç¤º');
        }

        function showFixSuggestions() {
            const suggestions = `
                <div style="font-size: 14px; line-height: 1.6;">
                    <h4>ğŸ”§ å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆï¼š</h4>
                    <ol>
                        <li><strong>æ¸…é™¤æµè§ˆå™¨ç¼“å­˜</strong><br>
                            æŒ‰ Ctrl+Shift+Deleteï¼Œæ¸…é™¤æµè§ˆå™¨ç¼“å­˜å’ŒCookie</li>
                        <li><strong>ç¦ç”¨ä»£ç†è®¾ç½®</strong><br>
                            æµè§ˆå™¨è®¾ç½® â†’ é«˜çº§ â†’ ç³»ç»Ÿ â†’ å…³é—­ä»£ç†æœåŠ¡å™¨</li>
                        <li><strong>å°è¯•å…¶ä»–æµè§ˆå™¨</strong><br>
                            ä½¿ç”¨ Chromeã€Firefoxã€Edge ç­‰ä¸åŒæµè§ˆå™¨æµ‹è¯•</li>
                        <li><strong>æ£€æŸ¥é˜²ç«å¢™</strong><br>
                            æš‚æ—¶å…³é—­ Windows Defender é˜²ç«å¢™æµ‹è¯•</li>
                        <li><strong>åˆ·æ–°ç½‘ç»œè¿æ¥</strong><br>
                            ç¦ç”¨å¹¶é‡æ–°å¯ç”¨ç½‘ç»œé€‚é…å™¨</li>
                        <li><strong>ä½¿ç”¨å‘½ä»¤è¡Œæµ‹è¯•</strong><br>
                            è¿è¡Œ: curl http://${TARGET_IP}:${FRONTEND_PORT}</li>
                    </ol>
                    
                    <h4>ğŸ” è¯¦ç»†è¯Šæ–­æ­¥éª¤ï¼š</h4>
                    <ol>
                        <li>æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·</li>
                        <li>åˆ‡æ¢åˆ° Network(ç½‘ç»œ) æ ‡ç­¾é¡µ</li>
                        <li>å‹¾é€‰ "Preserve log"</li>
                        <li>åˆ·æ–°é¡µé¢å¹¶è§‚å¯Ÿå¤±è´¥çš„è¯·æ±‚</li>
                        <li>ç‚¹å‡»å¤±è´¥çš„è¯·æ±‚æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯</li>
                    </ol>
                </div>
            `;
            
            document.getElementById('fix-suggestions').innerHTML = suggestions;
            log('ä¿®å¤å»ºè®®å·²æ˜¾ç¤º');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ˜¾ç¤ºæµè§ˆå™¨ä¿¡æ¯
        window.onload = function() {
            log('PTç«™ç½‘ç»œè¯Šæ–­å·¥å…·å·²å¯åŠ¨');
            log(`ç›®æ ‡æœåŠ¡å™¨: ${TARGET_IP}`);
            log(`å‰ç«¯ç«¯å£: ${FRONTEND_PORT}`);
            log(`åç«¯ç«¯å£: ${BACKEND_PORT}`);
            showBrowserInfo();
        };

        // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
        window.addEventListener('online', () => {
            log('ç½‘ç»œè¿æ¥å·²æ¢å¤', 'success');
        });

        window.addEventListener('offline', () => {
            log('ç½‘ç»œè¿æ¥å·²æ–­å¼€', 'error');
        });
    </script>
</body>
</html>

# ========================================
# PTç«™ç‚¹ HTTPS è·¯ç”±é…ç½®
# ========================================
# è¿™ä¸ªé…ç½®æ–‡ä»¶è¢«nginx.confåŒ…å«ï¼Œå®šä¹‰ç«™ç‚¹ç‰¹å®šçš„è·¯ç”±å’Œè®¾ç½®
# æŒ‰åŠŸèƒ½åˆ†ç»„çš„locationé…ç½®ï¼Œä¼˜åŒ–åŒ¹é…é¡ºåºä»¥æé«˜æ€§èƒ½

# ========================================
# 1. ç²¾ç¡®åŒ¹é…å’Œé«˜ä¼˜å…ˆçº§è·¯ç”±
# ========================================

# å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
location = /health {
    limit_req zone=general burst=10 nodelay;
    proxy_pass http://pt_backend;
    access_log off;
    
    # å¥åº·æ£€æŸ¥ä¸“ç”¨è¶…æ—¶
    proxy_connect_timeout 3s;
    proxy_send_timeout 3s;
    proxy_read_timeout 3s;
}

# æœºå™¨äººç®¡ç†
location = /robots.txt {
    add_header Content-Type text/plain;
    return 200 "User-agent: *\nDisallow: /api/\nDisallow: /admin/\nDisallow: /tracker/\nDisallow: /announce\n";
    access_log off;
}

# ========================================
# 2. Tracker æ ¸å¿ƒåŠŸèƒ½ï¼ˆPTç«™ä¸“ç”¨ï¼‰
# ========================================

# TrackeræœåŠ¡ - é«˜ä¼˜å…ˆçº§åŒ¹é…
location ~ ^/(announce|tracker)$ {
    limit_req zone=tracker burst=5 nodelay;
    limit_conn addr 10;
    
    # BitTorrentå®¢æˆ·ç«¯éªŒè¯
    set $allowed_agent 0;
    if ($http_user_agent ~* "(BitTorrent|uTorrent|qBittorrent|Transmission|Deluge|rtorrent|libtorrent|Azureus|BitComet|Vuze)") {
        set $allowed_agent 1;
    }
    # å¼€å‘ç¯å¢ƒå…è®¸æµè§ˆå™¨æµ‹è¯•
    if ($http_user_agent ~* "(Mozilla|Chrome|Safari|Firefox)") {
        set $allowed_agent 1;
    }
    if ($allowed_agent = 0) {
        return 403 "Access denied: Only BitTorrent clients allowed";
    }
    
    # Trackerä¸“ç”¨ä»£ç†é…ç½®
    proxy_pass http://pt_backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Trackerä¼˜åŒ–è®¾ç½®
    proxy_buffering off;
    proxy_read_timeout 30s;
    proxy_send_timeout 30s;
    proxy_connect_timeout 5s;
}

# ========================================
# 3. API è·¯ç”±é…ç½®
# ========================================

# ç®¡ç†å‘˜API - æ›´ä¸¥æ ¼çš„é™åˆ¶
location ~ ^/api/admin {
    limit_req zone=api burst=5 nodelay;
    limit_conn addr 5;
    
    # ç®¡ç†å‘˜APIä»£ç†
    proxy_pass http://pt_backend;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";
    
    # ç®¡ç†å‘˜ä¸“ç”¨è¶…æ—¶
    proxy_connect_timeout 10s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;
}

# æ–‡ä»¶ä¸Šä¼ API - ç‰¹æ®Šé…ç½®
location = /api/torrents/upload {
    limit_req zone=upload burst=3 nodelay;
    limit_conn addr 3;
    
    # å¤§æ–‡ä»¶ä¸Šä¼ ä¼˜åŒ–
    client_max_body_size 100M;
    client_body_buffer_size 128k;
    client_body_timeout 300s;
    
    # ä¸Šä¼ ä»£ç†é…ç½®
    proxy_pass http://pt_backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # ä¸Šä¼ è¶…æ—¶è®¾ç½®
    proxy_connect_timeout 10s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
    
    # ç¦ç”¨ç¼“å†²ä»¥æ”¯æŒå¤§æ–‡ä»¶
    proxy_request_buffering off;
    proxy_buffering off;
}

# é€šç”¨APIè·¯ç”±
location ~ ^/api {
    limit_req zone=api burst=20 nodelay;
    limit_conn addr 10;
    
    # APIä»£ç†é…ç½®
    proxy_pass http://pt_backend;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";
    
    # APIè¶…æ—¶å’Œç¼“å†²
    proxy_connect_timeout 5s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    # å“åº”ç¼“å†²ä¼˜åŒ–
    proxy_buffering on;
    proxy_buffer_size 8k;
    proxy_buffers 16 8k;
    proxy_busy_buffers_size 16k;
    
    # é”™è¯¯å¤„ç†å’Œé‡è¯•
    proxy_next_upstream error timeout invalid_header http_502 http_503 http_504;
    proxy_next_upstream_tries 3;
    proxy_next_upstream_timeout 10s;
}

# ========================================
# 4. é™æ€æ–‡ä»¶æœåŠ¡
# ========================================

# ä¸Šä¼ æ–‡ä»¶æœåŠ¡
location /uploads {
    limit_req zone=download burst=50 nodelay;
    
    # é™æ€æ–‡ä»¶è·¯å¾„
    alias C:/Users/qdsxh/Desktop/toys/pt/backend/uploads/;
    
    # é™æ€æ–‡ä»¶ä¼˜åŒ–
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    
    # æ–‡ä»¶ç±»å‹ç¼“å­˜ç­–ç•¥
    location ~* \.(torrent)$ {
        expires 1d;
        add_header Cache-Control "public, no-transform";
        add_header Content-Disposition "attachment";
    }
    
    location ~* \.(jpg|jpeg|png|gif|webp|svg)$ {
        expires 7d;
        add_header Cache-Control "public, no-transform";
    }
    
    # å®‰å…¨é…ç½®
    location ~* \.(exe|bat|sh|php|asp|jsp)$ {
        deny all;
    }
    
    # å…³é—­è®¿é—®æ—¥å¿—ä»¥æé«˜æ€§èƒ½
    access_log off;
}

# æµ‹è¯•æ–‡ä»¶å¤„ç†
location ~ ^/(test-.*\.html)$ {
    limit_req zone=general burst=10 nodelay;
    root C:/Users/qdsxh/Desktop/toys/pt;
    try_files $uri =404;
    expires 1h;
}

# ========================================
# 5. å‰ç«¯åº”ç”¨ä»£ç†
# ========================================

# Reactåº”ç”¨æ ¹è·¯å¾„
location / {
    limit_req zone=general burst=30 nodelay;
    
    # å¼€å‘ç¯å¢ƒï¼šä»£ç†åˆ°Reactå¼€å‘æœåŠ¡å™¨
    proxy_pass http://pt_frontend;
    proxy_http_version 1.1;
    
    # WebSocketæ”¯æŒ
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_cache_bypass $http_upgrade;
    
    # æ ‡å‡†ä»£ç†å¤´
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Reactå¼€å‘æœåŠ¡å™¨è¶…æ—¶
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}

# ========================================
# 6. å®‰å…¨ç­–ç•¥
# ========================================

# é˜»æ­¢è®¿é—®æ•æ„Ÿæ–‡ä»¶
location ~ /\.(env|git|sql|log|bak|backup)$ {
    deny all;
    return 404;
}

# é˜»æ­¢è®¿é—®æ•æ„Ÿç›®å½•
location ~ /(node_modules|\.git|database\.sqlite|backend/(?!uploads)|src|config|scripts) {
    deny all;
    return 404;
}

# é˜»æ­¢PHPç­‰è„šæœ¬æ‰§è¡Œ
location ~ \.(php|asp|jsp|cgi)$ {
    deny all;
    return 404;
}

# ========================================
# 7. é”™è¯¯é¡µé¢é…ç½®
# ========================================

# è‡ªå®šä¹‰é”™è¯¯é¡µé¢
error_page 404 /404.html;
error_page 500 502 503 504 /50x.html;

location = /50x.html {
    add_header Content-Type text/html;
    return 500 '<!DOCTYPE html><html><head><title>PTç«™æœåŠ¡æš‚æ—¶ä¸å¯ç”¨</title><meta charset="utf-8"></head><body style="font-family: Arial, sans-serif; text-align: center; margin-top: 100px;"><h1>ğŸ”§ æœåŠ¡æš‚æ—¶ä¸å¯ç”¨</h1><p>PTç«™æ­£åœ¨ç»´æŠ¤ä¸­ï¼Œè¯·ç¨åå†è¯•</p><p><a href="/" style="color: #007bff;">è¿”å›é¦–é¡µ</a></p></body></html>';
}

location = /404.html {
    add_header Content-Type text/html;
    return 404 '<!DOCTYPE html><html><head><title>é¡µé¢æœªæ‰¾åˆ°</title><meta charset="utf-8"></head><body style="font-family: Arial, sans-serif; text-align: center; margin-top: 100px;"><h1>ğŸ˜• é¡µé¢æœªæ‰¾åˆ°</h1><p>æ‚¨è®¿é—®çš„é¡µé¢ä¸å­˜åœ¨</p><p><a href="/" style="color: #007bff;">è¿”å›é¦–é¡µ</a></p></body></html>';
}

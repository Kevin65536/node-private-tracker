# PTç«™ç”¨æˆ·ä¸Šä¼ ä¸‹è½½æ•°æ®ç»Ÿè®¡åŠŸèƒ½å®ç°å®Œæˆ

## é¡¹ç›®æ¦‚è¿°

å·²æˆåŠŸå®ç°äº†å®Œæ•´çš„PTç«™ç”¨æˆ·ä¸Šä¼ ä¸‹è½½æ•°æ®é‡ç»Ÿè®¡åŠŸèƒ½ï¼ŒåŒ…æ‹¬åç«¯APIã€æ•°æ®æ¨¡å‹ã€å®šæ—¶ä»»åŠ¡ã€ç®¡ç†å·¥å…·å’Œå‰ç«¯ç»„ä»¶ã€‚

## âœ… å·²å®ç°åŠŸèƒ½

### 1. æ•°æ®æ¨¡å‹å’Œå­˜å‚¨
- **UserStats æ¨¡å‹**: ç”¨æˆ·ç»Ÿè®¡æ•°æ®è¡¨
  - ä¸Šä¼ é‡ (uploaded)
  - ä¸‹è½½é‡ (downloaded) 
  - åˆ†äº«ç‡ (ratio) è‡ªåŠ¨è®¡ç®—
  - åšç§æ—¶é—´ (seedtime)
  - ä¸‹è½½æ—¶é—´ (leechtime)
  - å¥–åŠ±ç§¯åˆ† (bonus_points)
  - é‚€è¯·æ•°é‡ (invitations)
  - ä¸Šä¼ ç§å­æ•° (torrents_uploaded)
  - åšç§ä¸­ç§å­æ•° (torrents_seeding)
  - ä¸‹è½½ä¸­ç§å­æ•° (torrents_leeching)

- **å…³è”å…³ç³»**: User â†” UserStats ä¸€å¯¹ä¸€å…³è”

### 2. ç»Ÿè®¡APIæ¥å£

#### ç”¨æˆ·ç»Ÿè®¡
- `GET /api/stats/user/:userId` - è·å–ç”¨æˆ·è¯¦ç»†ç»Ÿè®¡
- `POST /api/stats/user/:userId/update` - æ›´æ–°ç”¨æˆ·ç»Ÿè®¡ (ç®¡ç†å‘˜)
- `POST /api/stats/user/:userId/recalculate` - é‡æ–°è®¡ç®—ç»Ÿè®¡ (ç®¡ç†å‘˜)
- `GET /api/stats/user/:userId/activity` - è·å–ç”¨æˆ·æ´»åŠ¨å†å² (ç®¡ç†å‘˜)

#### æ’è¡Œæ¦œ
- `GET /api/stats/leaderboard` - è·å–ç”¨æˆ·æ’è¡Œæ¦œ
  - æ”¯æŒç±»å‹: uploaded, downloaded, ratio, bonus_points, seedtime
  - å¯é…ç½®æ˜¾ç¤ºæ•°é‡

#### å…¨ç«™ç»Ÿè®¡
- `GET /api/stats/global` - è·å–å…¨ç«™ç»Ÿè®¡æ¦‚è§ˆ
  - ç”¨æˆ·ç»Ÿè®¡ã€ç§å­ç»Ÿè®¡ã€æµé‡ç»Ÿè®¡
  - åˆ†ç±»ç»Ÿè®¡ã€æ´»è·ƒåº¦ç»Ÿè®¡

### 3. å®æ—¶æ•°æ®æ›´æ–°

#### Trackeré›†æˆ
- åœ¨ `handleAnnounce` ä¸­è‡ªåŠ¨æ›´æ–°ç”¨æˆ·ç»Ÿè®¡
- è®¡ç®—ä¸Šä¼ ä¸‹è½½å¢é‡å¹¶æ›´æ–°åˆ° UserStats
- è‡ªåŠ¨è®¡ç®—å’Œå‘æ”¾å¥–åŠ±ç§¯åˆ†

#### å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨
- **æ¯å°æ—¶**: æ›´æ–°æ´»è·ƒç§å­ç»Ÿè®¡
- **æ¯å¤©å‡Œæ™¨2ç‚¹**: é‡æ–°è®¡ç®—æ‰€æœ‰ç”¨æˆ·ç»Ÿè®¡
- **æ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹**: æ¸…ç†90å¤©å‰çš„announceæ—¥å¿—

### 4. ç®¡ç†å·¥å…·

#### å‘½ä»¤è¡Œç»Ÿè®¡ç®¡ç†å™¨ (stats-manager.js)
```bash
# æ˜¾ç¤ºå¸®åŠ©
node stats-manager.js help

# æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€
node stats-manager.js status

# æ›´æ–°æ‰€æœ‰ç”¨æˆ·ç»Ÿè®¡
node stats-manager.js update-all

# æ›´æ–°æŒ‡å®šç”¨æˆ·ç»Ÿè®¡
node stats-manager.js update-user 123

# éªŒè¯æ•°æ®ä¸€è‡´æ€§
node stats-manager.js verify

# è°ƒåº¦å™¨ç®¡ç†
node stats-manager.js scheduler-start
node stats-manager.js scheduler-stop
node stats-manager.js scheduler-status

# æ¸…ç†è¿‡æœŸæ•°æ®
node stats-manager.js cleanup

# é‡ç½®ç”¨æˆ·ç»Ÿè®¡
node stats-manager.js reset-user 123
```

### 5. å‰ç«¯ç»„ä»¶

#### UserStats ç»„ä»¶
- ä¸ªäººç»Ÿè®¡æ¦‚è§ˆé¡µé¢
- ç§å­ç»Ÿè®¡æ ‡ç­¾é¡µ
- æ´»åŠ¨å†å²æ ‡ç­¾é¡µ
- å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯

#### Leaderboard ç»„ä»¶
- å¤šç§æ’è¡Œæ¦œç±»å‹åˆ‡æ¢
- æ’åå¾½ç« å’Œè§†è§‰æ•ˆæœ
- åˆ†é¡µæ”¯æŒ

### 6. æµ‹è¯•å’ŒéªŒè¯

#### è‡ªåŠ¨åŒ–æµ‹è¯•å¥—ä»¶ (test-stats.js)
- APIæ¥å£æµ‹è¯•
- æ•°æ®è®¡ç®—éªŒè¯
- æƒé™éªŒè¯
- æ€§èƒ½æµ‹è¯•

#### åŠŸèƒ½éªŒè¯ âœ…
- å…¨ç«™ç»Ÿè®¡APIæ­£å¸¸å·¥ä½œ
- ç”¨æˆ·ç»Ÿè®¡APIè¿”å›æ­£ç¡®æ•°æ®
- æ’è¡Œæ¦œAPIæ”¯æŒå¤šç§ç±»å‹
- æ•°æ®ä¸€è‡´æ€§éªŒè¯é€šè¿‡

## ğŸ“Š æµ‹è¯•ç»“æœ

```bash
# ç³»ç»ŸçŠ¶æ€
ğŸ“Š æ•°æ®åº“ç»Ÿè®¡:
ç”¨æˆ·æ€»æ•°: 6
ç»Ÿè®¡è®°å½•: 6
ä¸‹è½½è®°å½•: 2
å…¬å‘Šæ—¥å¿—: 0

# APIæµ‹è¯•é€šè¿‡
âœ… å…¨ç«™ç»Ÿè®¡API: HTTP 200
âœ… ç”¨æˆ·ç»Ÿè®¡API: HTTP 200 
âœ… æ’è¡Œæ¦œAPI: HTTP 200

# æ•°æ®ä¸€è‡´æ€§
âœ… æ‰€æœ‰ç”¨æˆ·ç»Ÿè®¡æ•°æ®ä¸€è‡´
```

## ğŸš€ éƒ¨ç½²è¯´æ˜

### 1. å®‰è£…ä¾èµ–
```bash
cd backend
npm install node-cron
```

### 2. å¯åŠ¨æœåŠ¡
```bash
npm run dev
```

### 3. åˆå§‹åŒ–ç»Ÿè®¡æ•°æ®
```bash
node stats-manager.js update-all
```

### 4. å¯åŠ¨è°ƒåº¦å™¨
```bash
node stats-manager.js scheduler-start
```

## ğŸ“‹ APIç«¯ç‚¹æ€»è§ˆ

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° | è®¤è¯ |
|------|------|------|------|
| `/api/stats/global` | GET | å…¨ç«™ç»Ÿè®¡ | æ—  |
| `/api/stats/user/:id` | GET | ç”¨æˆ·ç»Ÿè®¡ | Token |
| `/api/stats/leaderboard` | GET | æ’è¡Œæ¦œ | Token |
| `/api/stats/user/:id/activity` | GET | ç”¨æˆ·æ´»åŠ¨ | ç®¡ç†å‘˜ |
| `/api/stats/user/:id/update` | POST | æ›´æ–°ç»Ÿè®¡ | ç®¡ç†å‘˜ |
| `/api/stats/user/:id/recalculate` | POST | é‡ç®—ç»Ÿè®¡ | ç®¡ç†å‘˜ |

## ğŸ”§ é…ç½®é¡¹

### ç¯å¢ƒå˜é‡
- æ•°æ®åº“è¿æ¥é…ç½®å·²å°±ç»ª
- JWTè®¤è¯é…ç½®å·²å°±ç»ª

### å®šæ—¶ä»»åŠ¡
- ç»Ÿè®¡æ›´æ–°é—´éš”: æ¯å°æ—¶
- å…¨é‡é‡ç®—: æ¯å¤©å‡Œæ™¨2ç‚¹
- æ—¥å¿—æ¸…ç†: æ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹

## ğŸ“ ä½¿ç”¨æŒ‡å—

### å‰ç«¯é›†æˆ
```jsx
import UserStats from './components/UserStats';
import Leaderboard from './components/Leaderboard';

// æ˜¾ç¤ºç”¨æˆ·ç»Ÿè®¡
<UserStats userId={user.id} isCurrentUser={true} />

// æ˜¾ç¤ºæ’è¡Œæ¦œ
<Leaderboard />
```

### ç®¡ç†æ“ä½œ
```bash
# å®šæœŸç»´æŠ¤
node stats-manager.js verify
node stats-manager.js cleanup

# æ•°æ®ä¿®å¤
node stats-manager.js update-all
node stats-manager.js reset-user 123
```

## ğŸ¯ åŠŸèƒ½ç‰¹ç‚¹

1. **å®æ—¶æ€§**: Tracker announceæ—¶å³æ—¶æ›´æ–°ç»Ÿè®¡
2. **å‡†ç¡®æ€§**: å¤šé‡éªŒè¯ç¡®ä¿æ•°æ®ä¸€è‡´æ€§  
3. **å®Œæ•´æ€§**: æ¶µç›–ä¸Šä¼ ä¸‹è½½ã€æ—¶é—´ã€ç§¯åˆ†ç­‰å¤šç»´åº¦
4. **å¯ç®¡ç†**: æä¾›å®Œæ•´çš„å‘½ä»¤è¡Œç®¡ç†å·¥å…·
5. **å¯æ‰©å±•**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ·»åŠ æ–°åŠŸèƒ½
6. **é«˜æ€§èƒ½**: ä¼˜åŒ–çš„SQLæŸ¥è¯¢å’Œç¼“å­˜æœºåˆ¶
7. **ç”¨æˆ·å‹å¥½**: ç›´è§‚çš„å‰ç«¯å±•ç¤ºç•Œé¢

## ğŸ“ˆ æ•°æ®æµç¨‹

```
Tracker Announce â†’ æ›´æ–° UserStats â†’ å®šæ—¶é‡ç®— â†’ APIå±•ç¤º â†’ å‰ç«¯æ˜¾ç¤º
                              â†“
                          ç®¡ç†å·¥å…·ç›‘æ§
```

## âœ¨ æ€»ç»“

PTç«™ç”¨æˆ·ä¸Šä¼ ä¸‹è½½æ•°æ®ç»Ÿè®¡åŠŸèƒ½å·²å®Œå…¨å®ç°å¹¶é€šè¿‡æµ‹è¯•éªŒè¯ã€‚ç³»ç»Ÿæä¾›äº†å®Œæ•´çš„æ•°æ®æ”¶é›†ã€è®¡ç®—ã€å­˜å‚¨ã€å±•ç¤ºå’Œç®¡ç†åŠŸèƒ½ï¼Œæ»¡è¶³äº†PTç«™å¯¹ç”¨æˆ·è¡Œä¸ºç»Ÿè®¡çš„æ‰€æœ‰éœ€æ±‚ã€‚

**æ ¸å¿ƒä»·å€¼:**
- ğŸ¯ å‡†ç¡®çš„æ•°æ®ç»Ÿè®¡å¸®åŠ©ç«™ç‚¹ç®¡ç†
- ğŸ† æ’è¡Œæ¦œæœºåˆ¶æ¿€åŠ±ç”¨æˆ·ç§¯æåˆ†äº«  
- ğŸ“Š ä¸°å¯Œçš„æ•°æ®å±•ç¤ºæå‡ç”¨æˆ·ä½“éªŒ
- ğŸ”§ å®Œå–„çš„ç®¡ç†å·¥å…·ç®€åŒ–è¿ç»´å·¥ä½œ
